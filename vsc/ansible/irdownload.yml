---
- name: Irdownload
  hosts: localhost
  become: true
  vars:
    # All sources that should be downloaded
    jobs:
      - bind_translation
      - biogrid
      - corum
      - dip
      - hprd
      - intact
      - intcomplex
      - mpact
      - mppi
      - bar
      - bhf_ucl
      - hpidb
      - huri
      - imex
      - innatedb
      - matrixdb
      - mbinfo
      - mint
      - mpidb
      - quickgo
      - reactome
      - uniprotpp
      - virushost
      - psi_mi
      - taxonomy
      - athaliana
      - bind
      - dig
      - fly
      - gene
      - genpept
      - ipi
      - mmdb
      - pdb
      - refseq
      - uniprot
      - yeast

  tasks:
    - name: Update apt packages
      ansible.builtin.apt:
        update_cache: true

    - name: Install required packages
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - ca-certificates
        - gnupg
        - curl
        - sudo

    - name: Add Google Cloud SDK repository
      ansible.builtin.lineinfile:
        dest: /etc/apt/sources.list.d/google-cloud-sdk.list
        line: "deb [signed-by=/usr/share/keyrings/cloud.google.asc] https://packages.cloud.google.com/apt cloud-sdk main"
        create: true
        mode: "0644"

    - name: Download Google Cloud SDK key
      ansible.builtin.get_url:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        dest: /usr/share/keyrings/cloud.google.asc
        mode: "0644"

    # - name: Import Google Cloud SDK key
    #   ansible.builtin.shell: "curl https://packages.cloud.google.com/apt/doc/apt-key.gpg 2>/dev/null | sudo tee /usr/share/keyrings/cloud.google.asc"
    #   args:
    #     creates: /usr/share/keyrings/cloud.google.asc

    - name: Update apt packages with Google Cloud SDK repository
      ansible.builtin.apt:
        update_cache: true
        force_apt_get: true

    # TODO: Figure out why this doesn't work
    # - name: Install Google Cloud CLI
    #   ansible.builtin.apt:
    #     name: google-cloud-sdk
    #     state: present

    - name: Run jobs
      ansible.builtin.command: "./irdownload {{ item | upper }}"
      args:
        chdir: "/home/irefindex/usr/bin"
      async: 3600
      poll: 0
      loop: "{{ jobs }}"
      register: result
      changed_when: false

    - name: Wait for jobs to complete
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 36
      delay: 5
      loop: "{{ result.results }}"

    - name: "Ensure that /data/irdata18/logs/irdownload/ exists"
      ansible.builtin.file:
        path: "/data/irdata18/logs/irdownload/"
        state: directory
        mode: "0755"

    - name: "Copy logs"
      ansible.builtin.copy:
        content: "{{ item.stdout }}"
        dest: "/data/irdata18/logs/irdownload/{{ item.invocation.module_args._raw_params.split() | last | lower }}.log"
        mode: "0644"
      when: item.stdout != ""
      loop: "{{ job_result.results }}"

    - name: "Copy error logs"
      ansible.builtin.copy:
        content: "{{ item.stderr }}"
        dest: "/data/irdata18/logs/irdownload/{{ item.invocation.module_args._raw_params.split() | last | lower }}.err.log"
        mode: "0644"
      when: item.stderr != ""
      loop: "{{ job_result.results }}"
