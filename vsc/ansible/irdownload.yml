---
- name: Irdownload
  hosts: localhost
  become: yes  # Execute tasks with sudo privileges

  tasks:
    - name: Update apt packages
      apt:
        update_cache: yes

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - ca-certificates
        - gnupg
        - curl
        - sudo

    - name: Add Google Cloud SDK repository
      lineinfile:
        dest: /etc/apt/sources.list.d/google-cloud-sdk.list
        line: "deb [signed-by=/usr/share/keyrings/cloud.google.asc] https://packages.cloud.google.com/apt cloud-sdk main"
        create: yes

    - name: Import Google Cloud SDK key
      shell: "curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo tee /usr/share/keyrings/cloud.google.asc"
      args:
        warn: false

    - name: Update apt packages with Google Cloud SDK repository
      apt:
        update_cache: yes
        force_apt_get: yes

    - name: Install Google Cloud CLI
      shell: "apt-get install google-cloud-cli"

    - name: Download IR data - BIND_TRANSLATION
      command: "./irdownload BIND_TRANSLATION"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      delay: 5
      async: 30
      poll: 0
      register: result_bind_translation

    - name: Download IR data - BIOGRID
      command: "./irdownload BIOGRID"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      delay: 5
      async: 60
      poll: 0
      register: result_biogrid

    - name: Download IR data - CORUM
      command: "./irdownload CORUM"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 60
      poll: 0
      register: result_corum

    - name: Download IR data - DIP
      command: "./irdownload DIP"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_dip

    - name: Download IR data - HPRD
      command: "./irdownload HPRD"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_hprd

    - name: Download IR data - INTACT
      command: "./irdownload INTACT"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_intact

    - name: Download IR data - INTCOMPLEX
      command: "./irdownload INTCOMPLEX"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_intcomplex

    - name: Download IR data - MPACT
      command: "./irdownload MPACT"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_mpact

    - name: Download IR data - MPPI
      command: "./irdownload MPPI"
      args:
        chdir: "/home/irefindex/usr/bin"
      ignore_errors: true
      retries: 3
      async: 30
      poll: 0
      register: result_mppi

    - name: Wait for BIND TRANSLATION to complete
      async_status:
        jid: "{{ result_bind_translation.ansible_job_id }}"
      register: job_result_1
      until: job_result_1.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for BIOGRID to complete
      async_status:
        jid: "{{ result_biogrid.ansible_job_id }}"
      register: job_result_2
      until: job_result_2.finished
      retries: 4
      delay: 15
      ignore_errors: true

    - name: Wait for CORUM to complete
      async_status:
        jid: "{{ result_corum.ansible_job_id }}"
      register: job_result_3
      until: job_result_3.finished
      retries: 4
      delay: 15
      ignore_errors: true

    - name: Wait for DIP to complete
      async_status:
        jid: "{{ result_dip.ansible_job_id }}"
      register: job_result_4
      until: job_result_4.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for HPRD to complete
      async_status:
        jid: "{{ result_hprd.ansible_job_id }}"
      register: job_result_5
      until: job_result_5.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for INTACT to complete
      async_status:
        jid: "{{ result_intact.ansible_job_id }}"
      register: job_result_6
      until: job_result_6.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for INTCOMPLEX to complete
      async_status:
        jid: "{{ result_intcomplex.ansible_job_id }}"
      register: job_result_6
      until: job_result_6.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for MPACT to complete
      async_status:
        jid: "{{ result_mpact.ansible_job_id }}"
      register: job_result_7
      until: job_result_7.finished
      retries: 6
      delay: 5
      ignore_errors: true

    - name: Wait for MPPI to complete
      async_status:
        jid: "{{ result_mppi.ansible_job_id }}"
      register: job_result_8
      until: job_result_8.finished
      retries: 6
      delay: 5
      ignore_errors: true
